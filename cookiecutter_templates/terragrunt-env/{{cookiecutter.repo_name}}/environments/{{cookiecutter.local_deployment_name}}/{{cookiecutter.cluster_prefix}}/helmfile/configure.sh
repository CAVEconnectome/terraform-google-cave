#!/usr/bin/env bash
set -euo pipefail

# This script is generated by Terraform. Do not edit.
# Injected variables:
#   project:     em-270621
#   region:      us-west1
#   zone:        us-west1-b
#   cluster:     api5-cave
#   kubeContext: gke_em-270621_us-west1-b_api5-cave

# Run from the helmfile directory generated by Terraform
cd "$(dirname "$0")"

need() { command -v "$1" >/dev/null 2>&1 || { echo "Missing dependency: $1" >&2; exit 1; }; }
need gcloud
need kubectl
need helm
need helmfile

project="{{ cookiecutter.project_id }}"
region="{{ cookiecutter.region }}"
zone="{{ cookiecutter.zone }}"
cluster_name="{{ cookiecutter.cluster_name }}-cave"
kube_context="gke_{{ cookiecutter.project_id }}_{{ cookiecutter.zone }}_${cluster_name}"

echo "Setting gcloud project: ${project}"
gcloud config set project "${project}" >/dev/null

# Fetch kube credentials (prefer regional, fallback to zonal)
if [[ -n "${region}" ]]; then
  echo "Fetching credentials for cluster ${cluster_name} in region ${region}"
  if ! gcloud container clusters get-credentials "${cluster_name}" --region "${region}" --project "${project}"; then
    if [[ -n "${zone}" ]]; then
      echo "Retrying with zone ${zone}"
      gcloud container clusters get-credentials "${cluster_name}" --zone "${zone}" --project "${project}"
    fi
  fi
elif [[ -n "${zone}" ]]; then
  echo "Fetching credentials for cluster ${cluster_name} in zone ${zone}"
  gcloud container clusters get-credentials "${cluster_name}" --zone "${zone}" --project "${project}"
else
  echo "Neither region nor zone provided by Terraform" >&2
  exit 1
fi

# Ensure helm-diff plugin is installed
if ! helm plugin list | awk '{print $1}' | grep -qx "diff"; then
  echo "Installing helm-diff plugin"
  helm plugin install https://github.com/databus23/helm-diff
fi

# Select kube context
kubectl config use-context "${kube_context}" >/dev/null
kubectl get ns >/dev/null

echo "Cluster configured. You can now run:"
echo "  helmfile apply"
